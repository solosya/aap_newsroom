{{ set(this, 'title', _Blog.getBlogTitle()) }}

{% set dev = _AppHelper.getApplicationEnv() == 'PROD' ? false : false %}


{% cache 'indexCache_1' 300 %}


{% set networkData   = _Network.getNetworkData() %}
{% set blogData      = _Blog.getBlog(null, {'excludeMenus' : true}) %}
{% set blogName      = blogData.title %}
{% set layout        = blogData.layout %}
{% set layoutTitle   = _Page.getLayoutTitle() | lower | replace({' ': '_'}) %}
{% set config       = _Network.getThemeConfig() %}


{% set cacheKey = "index_popular" %}
{% set forceCache = true %}
{% set popularArticles = getCache(cacheKey, forceCache) %}
{% if (popularArticles is empty) %}
	{% set popularArticles = _Article.getPopularArticles({ 
        limit: 6, 
        blogId: blogData['id'],  
        interval: 36  
    }) %}
	{% set cache = setCache(cacheKey, popularArticles, 900, forceCache) %}
{% endif %}


{% set donations = "nr" %}


{% set limit = 12 %}
{% if layoutTitle | lower == 'newsroom_opinion' %}
	{% set limit = 14 %}
{% endif %}


{% set articlesArr = _Blog.getBlogFeed({'limit': limit, 'offset': 0, 'distribution': true}) %}
{% set articles = articlesArr.articles %}
{% set firstCount = articles | length %}
{% set nonPinnedCount = articlesArr.existingNonPinnedCount %}
{% set lastArticle = articles | last %}

<!-- used to index each article as we loop over throughout the template -->
{% set articleCount = 0 %}


{% set sections =  {
        "video": {
            "feed": "",
            "link": ""
        }, 
        "livingroom": {
            "feed": "",
            "link": ""
        }, 
        "lockerroom": {
            "feed": "",
            "link": ""
        }, 
        "climate emergency": {
            "feed": "",
            "link": ""
        }, 
        "economic recovery": {
            "feed": "",
            "link": ""
        },
        "election 2020" : {
            "feed" : "",
            "link": ""
        },
        "readingroom": {
            "feed": "",
            "link": ""
        },
        "technology": {
            "feed": "",
            "link": ""
        },
        "health & science": {
            "feed": "",
            "link": ""
        },
        "ideasroom": {
            "feed": "",
            "link": ""
        },
        "futurelearning": {
            "feed": "",
            "link": ""
        },
        "partner newsroom": {
            "feed": "",
            "link": ""
        },
        "newsroom pro": {
            "feed": "",
            "link": ""
        },
        "podcast card": {
            "feed": "",
            "link": ""
        },
        "investigations": {
            "feed": "",
            "link": ""
        },
        "sustainable future": {
            "feed": "",
            "link": ""
        },
        "puzzles": {
            "feed": "",
            "link": ""
        },
		"peter ellis, the creche case & me": {
            "feed": "",
            "link": ""
        }
    }
%}


{% for key, value in sections %}
	{% for blog in networkData.networkBlogs %}

		{% if blog.title | lower == key %}
			{% set sections = sections | merge({
                (key) : {
                    'feed': _Blog.getBlogFeed({'limit': 8, 'offset': 0, 'blogid':blog.guid}),
                    'link' : blog.link
                    }
                }) %}
		{% endif %}
	{% endfor %}
{% endfor %}


{# Fill all sections with content from a single section
So you don't have to create all the sections on dev #}
{% if dev %}
	{% set devSection = sections['readingroom']%}
	{% for key, section in sections %}
		{% set sections = sections | merge({
            (key) : {
                'feed': devSection.feed,
                'link' : blog.link
                }
            }) %}
	{% endfor %}
{% endif %}


<main id="main" class="site-main" role="main" data-test="true" data-ver="3">

</main>


{# <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
        var card = new Acme.Card();
        Acme.loadMore = new Acme.ArticleFeed(card, {{limit}}, {{firstCount}}, false);
    });
</script> #}
<script>
	document.addEventListener("DOMContentLoaded", function (event) {
const events = new Acme.Card();

Acme.loadMore = new Acme.ArticleFeed({
model: Acme.Card,
container: 'loadmore_section',
offset: {{ articleCount }},
limit: 12,
label: "Load more articles",
imgwidth: "220",
imgheight: "208",
name: 'section-load',
blogid: "{{ blogData['guid'] }}",
card_class: 'col-md-4 card-sm card-sm-tablet card-sm-mobile',
non_pinned: "{{ nonPinnedCount }}"
});
});
</script>


{% endcache %}
